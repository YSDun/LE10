```{r install packages}
# install.packages("pkgbuild")
# pkgbuild::check_build_tools(debug = TRUE)
# install.packages("h2o", type="source", repos=(c("http://h2o-release.s3.amazonaws.com/h2o/latest_stable_R")))
# install.packages("lubridate")
# install.packages("devtools")
# install.packages("lubridate")
# install.packages("ukbtools")
# install.packages("data.table")
# install.packages("Hmisc")
# install.packages("dplyr")
# install.packages("readxl")
# install.packages("purrr")
# install.packages("readr")
# install.packages("msm")
# install.packages("elect")
# install.packages("mice")
# install.packages("MatchThem")
# install.packages("MatchIt")
# install.packages("timeROC")
# install.packages("survivalROC")
# install.packages("pROC")
# install.packages("survminer")
# install.packages("ggplot2")
# install.packages("skimr")
# install.packages("nnet", type="source", repos=(c("http://h2o-release.s3.amazonaws.com/h2o/latest_stable_R")))
# install.packages("XML", type="source", repos=(c("http://h2o-release.s3.amazonaws.com/h2o/latest_stable_R")))
# library(skimr)
# library(devtools)
# library("lubridate")
# library("ukbtools")
# library("data.table")
# library("Hmisc")
# library("dplyr")
# #library("h2o")
# library("readxl")
# library("purrr")
# library("readr")
# library("msm")
# library("elect") #https://www.ucl.ac.uk/~ucakadl/ELECT/ELECTManual_version0_2.pdf
# library("mice")
# library("MatchThem")
# library("MatchIt")
# library("timeROC")
# library("survival")
# library("survivalROC")
# library("pROC")
# library("survminer")

```


```{r set global}
# options(scipen = 999)
```


```{r upload}
# load("data22.RData")
```


```{r restricted cubic spline}
library(rms)

dd<-datadist(data_cox)
options(datadist='dd')

#####################################################################################
##To examine the nonlinear relationship between LE10 score and outcomes
#####################################################################################
#AIC and BIC methods were used to calculate the model fit degree under different node selection to determine the maximum number of festival points
results <- data.frame(knot = 3:10, AIC = NA, BIC = NA)
n <- nrow(data_cox)
for (knot in 3:10) {
  fit <- cph(Surv(time, status) ~ rcs(total_score, knot) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox)
  tmp <- extractAIC(fit)
  results$AIC[knot - 2] <- tmp[2]
  loglik <- tmp[1] 
  k <- tmp[2]      
  results$BIC[knot - 2] <- -2 * loglik + log(n) * k  # calculate BIC
}
results  # View AIC and BIC values for the number of nodes
nk_AIC <- results$knot[which.min(results$AIC)]  
nk_AIC
nk_BIC <- results$knot[which.min(results$BIC)] 
nk_BIC

#Construct and compare models [all nodes with 3.4.5 are constructed and compared]
fit1 <- cph(Surv(time,status)~rcs(total_score_LE8,3) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit1);fit1
fit2 <- cph(Surv(time,status)~rcs(total_score_LE8,4) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit2);fit2
fit3 <- cph(Surv(time,status)~rcs(total_score_LE8,5) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit3);fit3

fit <- cph(Surv(time,status) ~ rcs(total_score,3) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox) 
fit
cox.zph(fit,"rank")
HR<-rms::Predict(fit, total_score, fun=exp, ref.zero=TRUE)
head(HR)
anova(fit)

#####################################################################################
##To examine the nonlinear relationship between alcohol_intake and outcomes
#####################################################################################
results <- data.frame(knot = 3:10, AIC = NA, BIC = NA)
n <- nrow(data_cox) 
for (knot in 3:10) {
  fit <- cph(Surv(time, status) ~ rcs(alcohol_intake, knot) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox)
  tmp <- extractAIC(fit)
  results$AIC[knot - 2] <- tmp[2]
  loglik <- tmp[1] 
  k <- tmp[2]      
  results$BIC[knot - 2] <- -2 * loglik + log(n) * k  
}
results  
nk_AIC <- results$knot[which.min(results$AIC)]  
nk_AIC
nk_BIC <- results$knot[which.min(results$BIC)]  
nk_BIC

fit1 <- cph(Surv(time,status)~rcs(alcohol_intake,3) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit1);fit1
fit2 <- cph(Surv(time,status)~rcs(alcohol_intake,4) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit2);fit2
fit3 <- cph(Surv(time,status)~rcs(alcohol_intake,5) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit3);fit3
fit <- cph(Surv(time,status) ~ rcs(alcohol_intake,4) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox) 
fit
cox.zph(fit,"rank")
HR<-rms::Predict(fit, alcohol_intake, fun=exp, ref.zero=TRUE)
head(HR)
anova(fit)

#####################################################################################
##To examine the nonlinear relationship between PHQ2_score and outcomes
#####################################################################################
results <- data.frame(knot = 3:10, AIC = NA, BIC = NA)
n <- nrow(data_cox) 
for (knot in 3:10) {
  fit <- cph(Surv(time, status) ~ rcs(PHQ2_score, knot) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox)
  tmp <- extractAIC(fit)
  results$AIC[knot - 2] <- tmp[2]
  loglik <- tmp[1]  
  k <- tmp[2]      
  results$BIC[knot - 2] <- -2 * loglik + log(n) * k  
}
results  
nk_AIC <- results$knot[which.min(results$AIC)]  
nk_AIC
nk_BIC <- results$knot[which.min(results$BIC)]  
nk_BIC

fit1 <- cph(Surv(time,status)~rcs(PHQ2_score,3) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit1);fit1
fit2 <- cph(Surv(time,status)~rcs(PHQ2_score,4) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit2);fit2
fit3 <- cph(Surv(time,status)~rcs(PHQ2_score,5) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history,data=data_cox);anova(fit3);fit3
fit <- cph(Surv(time,status) ~ rcs(PHQ2_score,4) + strat(age_group) + sex + TDI + ethnicity + education + income + family_history, x=TRUE, y=TRUE, data=data_cox)
fit <- cph(Surv(time,status) ~ rcs(PHQ2_score,4), x=TRUE, y=TRUE, data=data_cox)
fit
cox.zph(fit,"rank")
HR<-rms::Predict(fit, PHQ2_score, fun=exp, ref.zero=TRUE)
head(HR)
anova(fit)

rm(bottom_row,cox_model,dd,fit,fit1,fit2,fit3,HR,plots,results,k,knot,loglik,n,nk_AIC,nk_BIC,tmp)
```


```{r Table1 baseline characteristics}
#####################################################################
# eTable 1. Baseline Characteristics by Cardiovascular Health (CVH) Level
# According to the AHA’s recommendations and the results of Cox models with restricted cubic splines for the LE10 score related to all-cause mortality, we categorized overall CVH into low (LE10 score <60), moderate (LE10 score ≥60 but <80), and high (LE10 score ≥80) levels.
#####################################################################
library(boot)
library(dplyr)
library(knitr)
library(table1)
sapply(data22, function(x) sum(is.na(x)))

### Baseline Characteristics by Cardiovascular Health (CVH) Level
data_table1 <- data22 %>%
  mutate(
    sex = factor(sex, levels = c(1,0), labels = c("Male", "Female")),
    ethnicity = factor(ethnicity_cat, levels = c("White", "Asian", "Black", "Mixed","Other ethnicity")),
    # ethnicity = case_when(
    #   ethnicity_cat == "White" ~ "White",
    #   ethnicity_cat == "Asian" | ethnicity_cat == "Black" | ethnicity_cat == "Mixed" | ethnicity_cat == "Other ethnicity" ~ "Non-white"),
    # ethnicity = factor(ethnicity, levels = c("Non-white", "White")),
    #education = factor(education_cat, levels = c("No qualifications", "CSEs or O levels/GCSEs or equivalent", "A levels/AS levels or equivalent", "Other professional qualifications", "NVQ or HND or HNC or equivalent", "College or University degree")),
    education = case_when(
      education_cat == "College or University degree" ~ "College or above",
      education_cat == "CSEs or O levels/GCSEs or equivalent" | education_cat == "A levels/AS levels or equivalent" | education_cat == "Other professional qualifications" | education_cat == "NVQ or HND or HNC or equivalent" ~ "High school or equivalent",
      education_cat == "No qualifications" ~ "Less than high school",
    ),
    income = factor(income_cat, levels = c("<18,000", "18,000-30,999", "31,000-51,999", "52,000-100,000", ">100,000")),
    family_history = factor(family_history, levels = c(0,1), labels = c("No", "Yes")),
    #employment = factor(employment_cat, levels = c("Unemployed", "In paid employment or self-employed")),
    CVH_level = case_when(
      total_score < 60 ~ "Low CVH", # Reference
      total_score >= 60 & total_score < 80 ~ "Moderate CVH",
      total_score >= 80 ~ "High CVH")
  )
# Factor the basic variables that we're interested in
data_table1$CVH_level <- 
  factor(data_table1$CVH_level, 
         levels = c("Low CVH", "Moderate CVH", "High CVH"))

label(data_table1$age_first_assessment) <- "Age, mean (SD), years"
label(data_table1$sex) <- "Sex"
label(data_table1$TDI) <- "Townsend deprivation index, mean (SD)"
label(data_table1$ethnicity) <- "Ethnicity, n (%)"
label(data_table1$education) <- "Education levels, n (%)"
label(data_table1$income) <- "Annual household income, n (%), £"
label(data_table1$family_history) <- "Family history, n (%)"
label(data_table1$total_score) <- "Total score"
label(data_table1$alcohol_score) <- "Alcohol consumption score"
label(data_table1$mental_health_score) <- "Mental health score"
label(data_table1$physical_activity_score) <- "Physical activity score"
label(data_table1$smoke_score) <- "Tobacco/nicotine exposure score"
label(data_table1$HDI_score) <- "Healthy diet score"
label(data_table1$sleep_score) <- "Sleep health score"
label(data_table1$BMI_score) <- "Body mass index score"
label(data_table1$BL_score) <- "Blood lipid score"
label(data_table1$BG_score) <- "Blood glucose score"
label(data_table1$BP_score) <- "Blood pressure score"

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=3), c("",
        "Mean (SD)"=sprintf("%s (%s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.1f %%)", FREQ, PCT))))
}

caption  <- "Table 1. Baseline Characteristics by Cardiovascular Health (CVH) Level"
footnote <- "Data are presented as mean (SD) for continuous variables or n (%) for categorical variables. Cardiovascular health (CVH) is categorized into three levels based on LE10 scores (low: <60; moderate: ≥60 and <80; and high: ≥80). Abbreviations: CSE, Certificate of Secondary Education; GCSE, General Certificate of Secondary Education; HNC, Higher National Certificate; NVQ, National Vocational Qualification."

table1(~age_first_assessment+sex+ethnicity+TDI+education+income+family_history+total_score+alcohol_score+mental_health_score+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score|CVH_level,data=data_table1,overall=c(left="Total"),caption=caption,footnote=footnote,render.continuous=my.render.cont, render.categorical=my.render.cat)

out <- table1(~age_first_assessment+sex+ethnicity+TDI+education+income+alcohol_score+mental_health_score+total_score+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score|CVH_level,data=data_table1,overall=c(left="Total"),caption=caption,footnote=footnote,render.continuous=my.render.cont, render.categorical=my.render.cat) 
table_data <- as.data.frame(out)
write.csv(table_data, file = , row.names = FALSE)


### eTable 1. Characteristics between participants with and without complete LE10 metrics
data_tmp  <- left_join(data_cov, data_out, by = c("eid"))
data_comparison  <- left_join(data_tmp, data_exp, by = c("eid"))
names(data_comparison)[names(data_comparison) == "age_first_assessment.x"] <- "age_first_assessment"
data_comparison$exp_na <- ifelse(is.na(data_comparison$total_score),1,0)
data_comparison <- data_comparison %>%
  mutate(
    exp_na = factor(exp_na, levels = c(1,0), labels = c("Excluded", "Included")),
    sex = factor(sex, levels = c(1,0), labels = c("Male", "Female")),
    ethnicity = factor(ethnicity_cat, levels = c("White", "Asian", "Black", "Mixed", "Other ethnicity")),
    education = factor(education_cat, levels = c("No qualifications", "CSEs or O levels/GCSEs or equivalent", "A levels/AS levels or equivalent", "Other professional qualifications", "NVQ or HND or HNC or equivalent", "College or University degree")),
    income = factor(income_cat, levels = c("<18,000", "18,000-30,999", "31,000-51,999", "52,000-100,000", ">100,000")),
    family_history = factor(family_history, levels = c(0,1), labels = c("No", "Yes")))

# label()
label(data_comparison$age_first_assessment) <- "Age, mean (SD), years"
label(data_comparison$sex) <- "Sex"
label(data_comparison$TDI) <- "Townsend deprivation index, mean (SD)"
label(data_comparison$ethnicity) <- "Ethnicity, n (%)"
label(data_comparison$education) <- "Education levels, n (%)"
label(data_comparison$income) <- "Annual household income, n (%), £"
label(data_comparison$family_history) <- "Family history, n (%)"

pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
caption  <- "eTable 1. Characteristics between participants with and without complete LE10 metrics"
footnote <- "Data are presented as mean (SD) for continuous variables or n (%) for categorical variables. Abbreviations: CSE, Certificate of Secondary Education; GCSE, General Certificate of Secondary Education; HNC, Higher National Certificate; NVQ, National Vocational Qualification."
table1(~age_first_assessment+sex+ethnicity+TDI+education+income+family_history|exp_na,data=data_comparison,overall=F,caption=caption,footnote=footnote,render.continuous=my.render.cont,render.categorical=my.render.cat,extra.col=list(`P-value`=pvalue)) 


### eTable 2. Baseline characteristics of the study participants according to the number of low-risk LE10 metrics
data_table1 <- data_table1 %>%
  mutate(
    ideal_number = case_when(
      ideal_number < 6 ~ "0-5", # Reference
      ideal_number >= 6 & ideal_number < 9 ~ "6-8",
      ideal_number >= 9 ~ "9-10"),
    factor(ideal_number, levels = c("0-5", "6-8", "9-10"))
  )
strata <- c(split(data_table1, data_table1$ideal_number), list(Overall=data_table1))
# label()
label(data_table1$ideal_number) <- "Number of low-risk LE10 metrics"
labels <- list(
    variables=list(age_first_assessment="Age, mean (SD), years", sex="Sex", TDI="Townsend deprivation index, mean (SD)", ethnicity="Ethnicity, n (%)", education="Education levels, n (%)", income="Annual household income, n (%), £", family_history="Family history", alcohol_score="Alcohol consumption score", mental_health_score="Mental health score", physical_activity_score="Physical activity score", smoke_score="Tobacco/nicotine exposure score", HDI_score="Healthy diet score", sleep_score="Sleep health score", BMI_score="Body mass index score", BL_score="Blood lipid score", BG_score="Blood glucose score", BP_score="Blood pressure score"),
    groups=list("Number of low-risk LE10 metrics",""))

caption  <- "eTable 2. Baseline characteristics of the study participants according to the number of low-risk LE10 metrics"
footnote <- "Data are presented as mean (SD) for continuous variables or n (%) for categorical variables. Abbreviations: CSE, Certificate of Secondary Education; GCSE, General Certificate of Secondary Education; HNC, Higher National Certificate; NVQ, National Vocational Qualification."

table1(~age_first_assessment+ethnicity+TDI+education+income+family_history+total_score+alcohol_score+mental_health_score+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score|ideal_number,data=data_table1,overall=c(right="Total"),caption=caption,footnote=footnote,render.continuous=my.render.cont, render.categorical=my.render.cat)
table1(strata, labels, groupspan=c(3,1), caption=caption, footnote=footnote,
       render.continuous=my.render.cont, render.categorical=my.render.cat)


### eTable 3. Baseline characteristics between men and women
# Render descriptive statistics for continuous and categorical variables separately
my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=3), c("",
        "Mean (SD)"=sprintf("%s (%s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.1f %%)", FREQ, PCT))))
}
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
caption  <- "eTable 3. Baseline characteristics between male and female participants"
footnote <- "Data are presented as mean (SD) for continuous variables or n (%) for categorical variables. Abbreviations: CSE, Certificate of Secondary Education; GCSE, General Certificate of Secondary Education; HNC, Higher National Certificate; NVQ, National Vocational Qualification."

table1(~age_first_assessment+ethnicity+TDI+education+income+family_history+total_score+alcohol_score+mental_health_score+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score|sex,data=data_table1,overall=F,caption=caption,footnote=footnote,render.continuous=my.render.cont,render.categorical=my.render.cat,extra.col=list(`P-value`=pvalue))

```


```{r univariate cox regression}
library(dplyr)
library(ezcox)
library(knitr)
covariates <- c("age", "sex", "ethnicity", "education", "income", "TDI", "family_history", "physical_activity_score", "smoke_score", "HDI_score", "sleep_score", "BMI_score", "BL_score", "BG_score", "BP_score", "alcohol_score", "mental_health_score")

univariate_cox_analysis(data_cox, "survival_time", "death", covariates, "")
univariate_cox_analysis(data_cox, "survival_time", "CVD_mortality", covariates, "")
univariate_cox_analysis(data_cox, "survival_time", "cancer_mortality", covariates, "")
univariate_cox_analysis(data_cox, "survival_time_MACE", "MACE_incidence", covariates, "")
univariate_cox_analysis(data_cox, "survival_time_cancer", "cancer_incidence", covariates, "")
```


```{r Cox regression analysis}
library(dplyr)
library(survival)
library(data.table)
library(broom)
library(tibble)

data22$age <- data22$age_first_assessment
data_cox <- preprocess_data(data22)

cox_analysis(data_cox, "survival_time", "death", "")

cox_analysis(data_cox, "survival_time", "cancer_mortality", "")

cox_analysis(data_cox, "survival_time", "CVD_mortality", "")

cox_analysis(data_cox, "survival_time_MACE", "MACE_incidence", "")

cox_analysis(data_cox, "survival_time_cancer", "cancer_incidence", "")
```


```{r Cox regression analysis by subgroups}
library(dplyr)
library(survival)
library(data.table)
library(broom)
library(tibble)
cox_sub_analysis <- function(data, filter_col, filter_value, output_dir) {
  filtered_data <- data[data[[filter_col]] == filter_value, ]
  cox_analysis(filtered_data, "survival_time", "death", output_dir)
  cox_analysis(filtered_data, "survival_time", "cancer_mortality", output_dir)
  cox_analysis(filtered_data, "survival_time", "CVD_mortality", output_dir)
  cox_analysis(filtered_data, "survival_time_MACE", "MACE_incidence", output_dir)
  cox_analysis(filtered_data, "survival_time_cancer", "cancer_incidence", output_dir)
}

data22$age <- data22$age_first_assessment
data_cox <- preprocess_data(data22)

cox_sub_analysis(data_cox, "age_group", "<60 years", "")
cox_sub_analysis(data_cox, "age_group", "≥60 years", "")

cox_sub_analysis(data_cox, "sex", "Male", "")
cox_sub_analysis(data_cox, "sex", "Female", "")

cox_sub_analysis(data_cox, "TDI_sub", 0, "")
cox_sub_analysis(data_cox, "TDI_sub", 1, "")

cox_sub_analysis(data_cox, "ethnicity", "Non-white", "")
cox_sub_analysis(data_cox, "ethnicity", "White", "")

cox_sub_analysis(data_cox, "education_sub", 0, "")
cox_sub_analysis(data_cox, "education_sub", 1, "")

cox_sub_analysis(data_cox, "income_sub", 0, "")
cox_sub_analysis(data_cox, "income_sub", 1, "")

cox_sub_analysis(data_cox, "family_history", "No", "")
cox_sub_analysis(data_cox, "family_history", "Yes", "")
```


```{r Competing risk model}
library(cmprsk)
library(riskRegression)
library(pec)

####################################
# CVD mortality
####################################
data_cmprsk$status <- ifelse(data_cmprsk$CVD_mortality==1,1,ifelse(data_cmprsk$all_cause_mortality==1,2,0))
data_cmprsk$event <- factor(data_cmprsk$status, levels=c(0,1,2), labels=c("Alive", "Death from CVD", "Death other causes"))

###Application condition judgment - the sub-distribution satisfies the PH assumption
data_1 <- data_cmprsk[data_cmprsk$status!=2,] 
data_2 <- data_cmprsk[data_cmprsk$status!=1,] 
data_2$status <- ifelse(data_2$status==0,0,1) 
cox_1 <- coxph (formula = Surv(time, status) ~ age_group + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_1, id = eid)  
cox_2 <- coxph (formula = Surv(time, status) ~ age_group + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_2, id = eid)  
ph_1 <- cox.zph(cox_1)  
ph_2 <- cox.zph(cox_2)  
ph_1 
ph_2 
ggcoxzph(ph_1)  
ggcoxzph(ph_2)  

###Application condition judgment - multicollinearity
library ('car')  
data_lm <- data_cmprsk  
data_lm$Group <- 1:length(data_lm[,1])  
lm_model <- lm (formula = status ~ age + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_lm)  
vif(lm_model)  #calculte vif

#CVH_level
#1.glm() for feature table
tab <- glm(event~age_group+sex+TDI+ethnicity+education+income+family_history+CVH_level,data=data_cmprsk,family="binomial")
#2.crrFormula for Multivariate regression
mul3 <- crrFormula(time+status~age_group+sex+TDI+ethnicity+education+income+family_history+CVH_level,data=data_cmprsk)
autoReg(tab,uni=F,mul=F)%>%
  addFitSummary(mul3,"HR (competing risks multivariable)") %>% 
  myft()

#ideal_number
#1.glm()for feature table
tab <- glm(event~age_group+sex+TDI+ethnicity+education+income+family_history+ideal_number,data=data_cmprsk,family="binomial")
#2.crrFormula for Multivariate regression
mul3 <- crrFormula(time+status~age_group+sex+TDI+ethnicity+education+income+family_history+ideal_number,data=data_cmprsk)
autoReg(tab,uni=F,mul=F)%>%
  addFitSummary(mul3,"HR (competing risks multivariable)") %>% 
  myft()

####################################
# Cancer mortality
####################################
data_cmprsk$status <- ifelse(data_cmprsk$cancer_mortality==1,1,ifelse(data_cmprsk$all_cause_mortality==1,2,0))
data_cmprsk$event <- factor(data_cmprsk$status, levels=c(0,1,2), labels=c("Alive", "Death from cancer", "Death other causes"))

###Application condition judgment - the sub-distribution satisfies the PH assumption
data_1 <- data_cmprsk[data_cmprsk$status!=2,]
data_2 <- data_cmprsk[data_cmprsk$status!=1,]
data_2$status <- ifelse(data_2$status==0,0,1)
cox_1 <- coxph (formula = Surv(time, status) ~ age_group + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_1, id = eid)  
cox_2 <- coxph (formula = Surv(time, status) ~ age_group + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_2, id = eid)  
ph_1 <- cox.zph(cox_1)  
ph_2 <- cox.zph(cox_2)  
ph_1 
ph_2 
ggcoxzph(ph_1) 
ggcoxzph(ph_2) 

###Application condition judgment - multicollinearity
library ('car')  
data_lm <- data_cmprsk  
data_lm$Group <- 1:length(data_lm[,1]) 
lm_model <- lm (formula = status ~ age + sex + TDI + ethnicity + education + income + family_history + physical_activity_score + alcohol_score + smoke_score + HDI_score + sleep_score + BMI_score + BL_score + BG_score + BP_score + mental_health_score, data = data_lm)  
vif(lm_model)  # calculate vif

#CVH_level
#1.glm() for feature table
tab <- glm(event~age_group+sex+TDI+ethnicity+education+income+family_history+CVH_level,data=data_cmprsk,family="binomial")
#2.crrFormula for Multivariate regression
mul3 <- crrFormula(time+status~age_group+sex+TDI+ethnicity+education+income+family_history+CVH_level,data=data_cmprsk)
autoReg(tab,uni=F,mul=F)%>%
  addFitSummary(mul3,"HR (competing risks multivariable)") %>% 
  myft()

#ideal_number
#1.glm() for feature table
tab <- glm(event~age_group+sex+TDI+ethnicity+education+income+family_history+ideal_number,data=data_cmprsk,family="binomial")
#2.crrFormula for Multivariate regression
mul3 <- crrFormula(time+status~age_group+sex+TDI+ethnicity+education+income+family_history+ideal_number,data=data_cmprsk)
autoReg(tab,uni=F,mul=F)%>%
  addFitSummary(mul3,"HR (competing risks multivariable)") %>% 
  myft()
```


```{r Calculation of biological ages (KDM-BA, PhenoAge)}
#install.packages("devtools")
#devtools::install_github("dayoonkwon/BioAge")
library(BioAge)

## KDM-BA
#Train algorithms in NHANES III and project biological ageing measures in NHANES IV
biomarkers <- c("fev","sbp","totchol","hba1c","albumin","creat","lncrp","alp","bun")

#Train using the NHANES III
train = kdm_calc(NHANES3,
                 biomarkers = c("fev","sbp","totchol","hba1c","albumin",
                 "creat","lncrp","alp","bun"))

#Project into the NHANES IV
kdm = kdm_calc(NHANES4,
               biomarkers = c("fev","sbp","totchol","hba1c","albumin",
               "creat","lncrp","alp","bun"),
               fit = train$fit,
               s_ba2 = train$fit$s_ba2)

#Projecting KDM-BA into new data using NHANES III (separate training for gender)
kdm_fem = kdm_calc(data = data_KDM %>%
                        filter (gender == 0),
                      biomarkers=c("fev","sbp","totchol","hba1c","albumin","creat","lncrp","alp","bun"),
                   fit = kdm$fit$female,
                   s_ba2 = kdm$fit$female$s_b2)

kdm_male = kdm_calc(data = data_KDM %>%
                         filter (gender == 1),
                       biomarkers=c("fev","sbp","totchol","hba1c","albumin","creat","lncrp","alp","bun"),
                   fit = kdm$fit$male,
                   s_ba2 = kdm$fit$male$s_b2)

#Combine the datasets
kdm_UK = rbind(kdm_fem$data, kdm_male$data)

## PhenoAge
#Train algorithms in NHANES III and project biological ageing measures in NHANES IV
biomarkers <- c("albumin_gL","lymph","mcv","glucose_mmol","rdw","creat_umol","lncrp","alp","wbc")

#Train using the NHANES III
train = phenoage_calc(NHANES3,
                      biomarkers = c("albumin_gL","lymph","mcv","glucose_mmol",
                      "rdw","creat_umol","lncrp","alp","wbc"))

#Project into the NHANES IV
phenoage = phenoage_calc(NHANES4,
                         biomarkers = c("albumin_gL","lymph","mcv","glucose_mmol",
                         "rdw","creat_umol","lncrp","alp","wbc"),
                         fit = train$fit)

#Projecting PhenoAge into new data using NHANES III
phenoage = phenoage_calc(data_BA,
                         biomarkers = c("albumin_gL","lymph","mcv","glucose_mmol",
                                        "rdw","creat_umol","lncrp","alp","wbc"), 
                         fit = train$fit, 
                         orig = FALSE)
#Extract phenoage dataset
pheno_UK = phenoage$data

```


```{r Logistic regression model}
# List of response variables (binary outcomes)
response_variables <- c("kdm_AA_binary", "pheno_AA_binary")

# Covariates for model adjustment
covariates <- c("age_first_assessment", "sex", "ethnicity", "TDI", "education", "income", "family_history")

# Initialize empty dataframe to store results
results_OR <- data.frame(
  trait = character(),
  CVH_level = character(),
  beta = numeric(),
  se = numeric(),
  pvalue = numeric(),
  stringsAsFactors = FALSE
)

# Initialize empty list to store results per response variable
level_results <- list()

# Loop through each response variable
for (response in response_variables) {
  # Create model formula
  formula <- as.formula(paste0(response, "~", "CVH_level", "+", paste(covariates, collapse = " + ")))
  
  # Fit logistic regression model
  model <- glm(formula, data = newdata_subset, family = binomial)
  
  # Get model summary
  summary_result <- summary(model)
  
  # Extract coefficients table (excluding intercept, focusing on CVH_level)
  coef_names <- grep("^CVH_level", rownames(summary_result$coefficients), value = TRUE, ignore.case = TRUE)
  coef_table <- summary_result$coefficients[coef_names, ]
  
  # Temporary storage for current response variable results
  current_level_results <- list()
  
  # Loop through each row in coefficient table
  for (i in 1:nrow(coef_table)) {
    # Extract current row information
    estimate <- coef_table[i, "Estimate"]
    std_error <- coef_table[i, "Std. Error"]
    p_value <- coef_table[i, "Pr(>|z|)"]
    predictor <- rownames(coef_table)[i]  # Get the predictor name (CVH_level category)
    
    # Store results for current level
    current_level_results[[i]] <- data.frame(
      trait = response,
      CVH_level = predictor,
      beta = estimate,
      se = std_error,
      pvalue = p_value,
      stringsAsFactors = FALSE
    )
  }
  
  # Combine results for current response variable
  results_temp <- do.call(rbind, current_level_results)
  results_OR <- rbind(results_OR, results_temp)
}

# View analysis results
print(results_OR)

# Calculate odds ratios and 95% CIs
results_OR <- results_OR %>%
  mutate(
    mean = exp(beta),  # Odds ratio
    lower = exp(log(mean) - 1.96 * se),  # Lower CI
    upper = exp(log(mean) + 1.96 * se),  # Upper CI
    across(where(is.numeric), ~round(., digits = 2)),  # Round all numeric values
    CVH_level = factor(CVH_level, 
                      levels = c("CVH_levelLow", "CVH_levelModerate", "CVH_levelHigh"), 
                      labels = c("Low CVH", "Moderate CVH", "High CVH")),
    `Odds ratio (95% CI)` = paste0(mean, " (", lower, " to ", upper, ")"),
    trait = factor(trait, levels = unique(trait))
  )
```


```{r panel data}
#########################################################################################
# REF: https://rdrr.io/cran/elect/man/electData.html#heading-5
#########################################################################################
len2 <- length(data22$eid)
data_f1           <- data.frame(matrix(nrow = len2, ncol = 0))
data_f1$eid       <- data22$eid
data_f1$state     <- 1
data_f1$age       <- data22$age_first_assessment
data_f1$bsline    <- 1

data_f2           <- data.frame(matrix(nrow = len2, ncol = 0))
data_f2$eid       <- data22$eid
data_f2$state     <- 2
data_f2$age       <- pmin(data22$MACE_incidence_age, data22$cancer_incidence_age, na.rm=TRUE)
data_f2$age       <- ifelse(is.na(data_f2$age),0,data_f2$age)
data_f2$bsline    <- 0
data_f2 <- data_f2[data_f2$age>0,]

data_f3           <- data.frame(matrix(nrow = len2, ncol = 0))
data_f3$eid       <- data22$eid
data_f3$state     <- 3
data_f3$age       <- data22$age_at_death
data_f3$age       <- ifelse(is.na(data_f3$age),0,data_f3$age)
data_f3$bsline   <- 0
data_f3 <- data_f3[data_f3$age>0,]

data_f            <- data.frame()
data_f <- rbind(data_f1, data_f2, data_f3)

data_f4           <- tally(group_by(data_f, eid))
data_f4           <- data_f4[data_f4$n==1,]
data_f4$state     <- 1 #censoring
data_f4           <- inner_join(data_f4,data22[,c("eid","age_censoring")],by = c("eid"))
data_f4$bsline    <- 0
names(data_f4)[names(data_f4) == "age_censoring"] <- "age"
data_f4           <- data_f4[,c("eid","state","age","bsline")]


data_f <- rbind(data_f1, data_f2, data_f3, data_f4)

```


```{r Life expectancies according to CVH levels}
data_msm <- left_join(data_f, data22, by = c("eid"))
data_msm <- data_msm[order(data_msm$eid, data_msm$age, data_msm$bsline),]
cat("Sample size:"); print(length(table(data_msm$eid)))
cat("Frequencies observed state:"); print(table(data_msm$state))
cat("State table:"); print(statetable.msm(state,eid,data=data_msm))

q <- 0.05; Q <- rbind(c(0,q,q), c(0,0,q),c(0,0,0))
model_CVH_level <- msm(state~age, subject=eid, data=data_msm, center=FALSE, qmatrix=Q, deathexact=TRUE, method="BFGS", control=list(reltol=1e-16), 
covariates = ~ age+sex+CVH_level1+CVH_level2)
model_CVH_level

num_state3 <- sum(data_msm$state == 3)
num_state2 <- sum(data_msm$state == 2)
a <- as.data.frame(table(data_msm$eid))
num_state23 <- sum(a$Freq == 3)
num_state22 <- num_state2 - num_state23
num_state1 <- length(data22$eid)
num_state12 <- num_state2
num_state13 <- num_state3

### To calculate LEs for each specified CVH level
sddata <- data_msm[data_msm$state%in%c(1,2),]
ages <- c(50, 60, 70)  
sexs <- c(0, 1)
dummy_levels <- c(0, 1)  
probs <- c(.025, .5, .975)  
L_age <- length(ages)  
L_sex <- length(sexs)  
L_dummy <- length(dummy_levels)  
print(length(LEs$pnt))
s_num <- 2000
# Initialize a vector to store the estimated LEs  
LEs_CVH_level <- array(NA, c(L_age, L_sex, L_dummy, L_dummy, length(LEs$pnt), 6))
# Estimate LEs for each specified age, sex, and CVH level, and store the results
for (a in seq_along(ages)) {  
  for (s in seq_along(sexs)) {  
    for (h in 1:L_dummy) {  
      for (i in 1:L_dummy) {  
        age <- ages[a]  
        sex <- sexs[s]  
        CVH_level1 <- dummy_levels[h]  
        CVH_level2 <- dummy_levels[i]  
        cat(sprintf("Calculating LEs for age = %d, sex = %d, CVH level1 = %d, CVH level2 = %d\n", age, sex, CVH_level1, CVH_level2))
        results <- elect(model_CVH_level, b.covariates = list(age = age, sex = sex, CVH_level1 = CVH_level1, CVH_level2 = CVH_level2),  
                         statedistdata = sddata, h = 0.1, setseed = 1234, age.max = 110, S = s_num)
        for(f in 1:s_num){
          results$sim[f,6] <- (results$sim[f,4]*num_state22 + results$sim[f,6]*num_state23)/num_state2
          results$sim[f,7] <- results$sim[f,5] + results$sim[f,6]
        }
        results$pnt[6] <- (results$pnt[4]*num_state22 + results$pnt[6]*num_state23)/num_state2
        results$pnt[7] <- results$pnt[5] + results$pnt[6]
        summary.elect(results, probs = probs, digits = 3, print = TRUE)
        for (j in 1:7) {  
          for (k in 1:length(probs)) {  
            LEs_CVH_level[a, s, h, i, j, k] <- quantile(results$sim[, j], probs = probs[k])  
          }  
num_state11 <- num_state1 - num_state2 - num_state3
          LEs_CVH_level[a, s, h, i, j, 4] <- results$pnt[j]
          LEs_CVH_level[a, s, h, i, j, 5] <- mean(results$sim[, j])
          LEs_CVH_level[a, s, h, i, j, 6] <- sd(results$sim[, j])
        }  
      }  
    }  
  }  
}

```


```{r Model comparison}
#install.packages("BiocManager")
#BiocManager::install("survcomp")
#install.packages("compareC")
library(survcomp)
library(compareC)
library(survival)
library(rms) 
library(pec)

# LE8
model_LE8 <- coxph(Surv(time,status)~age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score, data=data_cox, x=TRUE)
Cindex_LE8 <- summary(model_LE8)$concordance
Cindex_LE8
# LE8+mental health score
model_LC9 <- coxph(Surv(time,status)~age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+mental_health_score, data=data_cox, x=TRUE)
Cindex_LC9 <- summary(model_LC9)$concordance
Cindex_LC9
# LE8+alcohol consumption score
model_LE9 <- coxph(Surv(time,status)~age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score, data=data_cox, x=TRUE)
Cindex_LE9 <- summary(model_LE9)$concordance
Cindex_LE9
# LE10
model_LE10 <- coxph(Surv(time,status)~age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score+mental_health_score, data=data_cox, x=TRUE)
Cindex_LE10 <- summary(model_LE10)$concordance
Cindex_LE10

#####################################################################
# Calculate C-indexes with survcomp package
#####################################################################
# LE8
Cindex_LE8 <- concordance.index(x=predict(model_LE8),
                                surv.time=data_cox$time,
                                surv.event=data_cox$status,
                                method="noether")
Cindex_LE8

# LE8+mental health score
Cindex_LC9 <- concordance.index(x=predict(model_LC9),
                                surv.time=data_cox$time,
                                surv.event=data_cox$status,
                                method="noether")
Cindex_LC9

# LE8+alcohol consumption score
Cindex_LE9 <- concordance.index(x=predict(model_LE9),
                                surv.time=data_cox$time,
                                surv.event=data_cox$status,
                                method="noether")
Cindex_LE9

# LE10
Cindex_LE10 <- concordance.index(x=predict(model_LE10),
                                 surv.time=data_cox$time,
                                 surv.event=data_cox$status,
                                 method="noether")
Cindex_LE10

cindex.comp1 <- cindex.comp(Cindex_LC9, Cindex_LE8)
cindex.comp2 <- cindex.comp(Cindex_LE9, Cindex_LE8)
cindex.comp3 <- cindex.comp(Cindex_LE10, Cindex_LE8)

p.value_decimal1 <- format(cindex.comp1$p.value, scientific = FALSE)
p.value_decimal2 <- format(cindex.comp2$p.value, scientific = FALSE)
p.value_decimal3 <- format(cindex.comp3$p.value, scientific = FALSE)

#####################################################################
# Calculate time-dependent AUC
#####################################################################
pred_LE8 <- predict(model_LE8, type = "lp")
pred_LC9 <- predict(model_LC9, type = "lp")
pred_LE9 <- predict(model_LE9, type = "lp")
pred_LE10 <- predict(model_LE10, type = "lp")

time_points <- seq(0, 15.6, by = 0.1)
time_roc_LE8 <- timeROC(T = data_cox$time, delta = data_cox$status, marker = pred_LE8, cause = 1, times = time_points)
time_roc_LC9 <- timeROC(T = data_cox$time, delta = data_cox$status, marker = pred_LC9, cause = 1, times = time_points)
time_roc_LE9 <- timeROC(T = data_cox$time, delta = data_cox$status, marker = pred_LE9, cause = 1, times = time_points)
time_roc_LE10 <- timeROC(T = data_cox$time, delta = data_cox$status, marker = pred_LE10, cause = 1, times = time_points)

# Extract AUC values
auc1 <- time_roc_LE8$AUC
auc2 <- time_roc_LC9$AUC
auc3 <- time_roc_LE9$AUC
auc4 <- time_roc_LE10$AUC

df_auc <- data.frame(
  Time = rep(time_points, 4),  
  AUC = c(auc1, auc2, auc3, auc4),  
  Model = c(rep("LE8", length(time_points)), rep("LC9", length(time_points)), rep("LE9", length(time_points)), rep("LE10", length(time_points)))
)
print(df_auc)


# Fit the logistic model for KDM-BA acceleration
# LE8
model1 <- glm(kdm_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score, data = kdm_UK, family = binomial, x = TRUE,y = TRUE)
# LE8+mental health score
model2 <- glm(kdm_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+mental_health_score, data = kdm_UK, family = binomial, x = TRUE,y = TRUE)
# LE8+alcohol consumption score
model3 <- glm(kdm_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score, data = kdm_UK, family = binomial, x = TRUE,y = TRUE)
# LE10
model4 <- glm(kdm_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score+mental_health_score, data = kdm_UK, family = binomial, x = TRUE,y = TRUE)

# Calculate prediction values
kdm_UK$predvalue1 <- predict(model1)
kdm_UK$predvalue2 <- predict(model2)
kdm_UK$predvalue3 <- predict(model3)
kdm_UK$predvalue4 <- predict(model4)

# Fit ROC
modelROC1 <- roc(kdm_UK$kdm_AA_binary, kdm_UK$predvalue1)
auc1 <- auc(modelROC1)
ci1 <- ci(auc1)
modelROC2 <- roc(kdm_UK$kdm_AA_binary, kdm_UK$predvalue2)
auc2 <- auc(modelROC2)
ci2 <- ci(auc2)
modelROC3 <- roc(kdm_UK$kdm_AA_binary, kdm_UK$predvalue3)
auc3 <- auc(modelROC3)
ci3 <- ci(auc3)
modelROC4 <- roc(kdm_UK$kdm_AA_binary, kdm_UK$predvalue4)
auc4 <- auc(modelROC4)
ci4 <- ci(auc4)

# Calculate the difference between two models using the roc.test function in the pROC package
roc_test_result1 <- roc.test(modelROC1, modelROC2)
roc_test_result2 <- roc.test(modelROC1, modelROC3)
roc_test_result3 <- roc.test(modelROC1, modelROC4)


# Fit the logistic model for PhenoAge acceleration
# LE8
model1 <- glm(pheno_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score, data = pheno_UK, family = binomial, x = TRUE,y = TRUE)
# LE8+mental health score
model2 <- glm(pheno_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+mental_health_score, data = pheno_UK, family = binomial, x = TRUE,y = TRUE)
# LE8+alcohol consumption score
model3 <- glm(pheno_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score, data = pheno_UK, family = binomial, x = TRUE,y = TRUE)
# LE10
model4 <- glm(pheno_AA_binary ~ age+sex+TDI+ethnicity+education+income+family_history+physical_activity_score+smoke_score+HDI_score+sleep_score+BMI_score+BL_score+BG_score+BP_score+alcohol_score+mental_health_score, data = pheno_UK, family = binomial, x = TRUE,y = TRUE)

# Calculate prediction values
pheno_UK$predvalue1 <- predict(model1)
pheno_UK$predvalue2 <- predict(model2)
pheno_UK$predvalue3 <- predict(model3)
pheno_UK$predvalue4 <- predict(model4)

# Fit ROC
modelROC1 <- roc(pheno_UK$pheno_AA_binary, pheno_UK$predvalue1)
auc1 <- auc(modelROC1)
ci1 <- ci(auc1)
modelROC2 <- roc(pheno_UK$pheno_AA_binary, pheno_UK$predvalue2)
auc2 <- auc(modelROC2)
ci2 <- ci(auc2)
modelROC3 <- roc(pheno_UK$pheno_AA_binary, pheno_UK$predvalue3)
auc3 <- auc(modelROC3)
ci3 <- ci(auc3)
modelROC4 <- roc(pheno_UK$pheno_AA_binary, pheno_UK$predvalue4)
auc4 <- auc(modelROC4)
ci4 <- ci(auc4)

# Calculate the difference between two models using the roc.test function in the pROC package
roc_test_result1 <- roc.test(modelROC1, modelROC2)
roc_test_result2 <- roc.test(modelROC1, modelROC3)
roc_test_result3 <- roc.test(modelROC1, modelROC4)

```

